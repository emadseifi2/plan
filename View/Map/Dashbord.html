<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

<style>
    body {
        overflow: hidden !important;
    }

    #FullPagePage {
        background: url(/Portals/2/Econet/Image/Map/patern-8-300.png);
        background-color: #ffffff !important;
        background-position: center center;
        background-repeat: repeat;
        background-size: 10%;
        overflow: hidden !important;
    }

    .accordion-button::after {
        background-size: 0.8rem;
    }

    .accordion-button span {
        color: #363636;
    }

    .accordion-button span i {
        color: #0066ff;
    }

    .bodyloader {
        width: 100vw;
        height: 100vh;
    }

    .dnnClear h2 {
        display: none;
    }

    .district-popup,
    .district-tooltip {
        font-family: sans-serif;
        text-align: center;
        min-width: 95px;
    }

    .district-popup-number {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
    }

    .district-popup-text {
        font-size: 0.95rem;
    }

    .accordion-button py-0 my-0 {
        background-color: #fff;
    }

    .accordion-button py-0 my-0::after {
        margin-left: 10px !important;
        margin-right: auto;
    }

    .accordion-button py-0 my-0:not(.collapsed) {
        color: #ffffff;
        background-color: #ff9600;
    }

    .accordion-button:not(.collapsed) span {
        color: #fff;
    }

    .accordion-button:not(.collapsed) span i {
        color: #fff;
    }

    .accordion-item:first-of-type>.accordion-header .accordion-button py-0 my-0 {
        border-radius: 0 !important;
    }

    .accordion-body {
        background: rgba(159, 239, 192, 0.4);
    }

    .accordion-item {
        border-radius: 0 !important;
        border: 0 !important;
    }

    .accordion-button py-0 my-0:focus {
        box-shadow: none !important
    }

    .accordion {
        background-color: transparent !important;
        --bs-accordion-bg: #ffffff00 !important;
    }

    .accordion-item:last-of-type>.accordion-header .accordion-button py-0 my-0.collapsed {
        border-radius: 0 !important;
    }

    .bodychart {
        position: absolute;
        left: -100vh;
        bottom: 10px;
        z-index: 999;
        background-color: #fff;
        border-radius: 10px;
        width: 40vw;
        -webkit-transition: all 0.6s ease-in-out;
        -moz-transition: all 0.6s ease-in-out;
        -o-transition: all 0.6s ease-in-out;
        transition: all 0.6s ease-in-out;
    }

    /* خصوصیات برای حالت موبایل */
    @media (max-width: 768px) {
        .bodychart {
            width: 85vw;
        }
    }

    .nav-link {
        color: #fff;
    }

    .nav-link:focus,
    .nav-link:hover {
        color: #00ff22;
    }

    #DivChart {
        width: 100%;
        height: 300px;
        direction: ltr !important;
        display: inline-block;
    }

    .closebodychart {
        position: absolute;
        left: 0;
        top: 0;
        z-index: 999;
    }

    #legendcolor li {
        text-align: right;
    }

    .legend {
        position: absolute;
        left: 10px;
        top: 10px;
        z-index: 9999;
        margin: 0 auto;
    }

    .legend-panel {
        z-index: 9999;
        padding: 5px;
        border-radius: 5px;
        background-color: #fff;
        box-shadow: 0 0 5px #4b4b4b;
        margin: 0 auto;
    }

    .legend-title {
        z-index: 9999;
        padding: 5px;
        border-radius: 5px;
        box-shadow: 0 0 4px #a3a3a3;
        margin: 0 auto;
    }

    /* //loader css */
    .SubMaploader {
        position: fixed;
        left: 0;
        right: 0;
        top: 25vh;
        margin: 0 auto;
        width: 100vw;
        text-align: center;
        z-index: 9999;
    }

    .Maploader {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        display: block;
        position: relative;
        border: 4px solid;
        border-color: #00ff62 #00ff15 transparent transparent;
        box-sizing: border-box;
        text-align: center;
        margin: 0 auto;
        animation: rotation 1s linear infinite;
    }

    .Maploader::after,
    .Maploader::before {
        content: '';
        box-sizing: border-box;
        position: absolute;
        left: 0;
        right: 0;
        top: 0;
        bottom: 0;
        margin: auto;
        border: 4px solid;
        border-color: transparent transparent #055f0c #025314;
        width: 88px;
        height: 88px;
        border-radius: 50%;
        box-sizing: border-box;
        animation: rotationBack 1.5s linear infinite;
        transform-origin: center center;
    }

    .Maploader::before {
        width: 76px;
        height: 76px;
        border-color: #00ffaa #00ffaa transparent transparent;
        animation: rotation 2.5s linear infinite;
    }

    @keyframes rotation {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    @keyframes rotationBack {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(-360deg);
        }
    }

    .titletop {
        position: fixed;
        right: 10px;
        top: 35px;
        margin: 0 auto;
        background-color: rgb(255 255 255);
        width: 17vw !important;
        border-bottom-left-radius: 50px;
        border-bottom-right-radius: 50px;
        padding: 5px 0;
        border-bottom: 1px solid #e1e1e1;
        z-index: 9999;
    }

    .titleimage {
        text-align: center;
        padding: 10px 5px 10px 2px;
    }

    .map-switch {
        position: relative;
        display: inline-block;
        width: 100px;
        height: 56px;
        border-radius: 50px;
        background-color: #ffffff;
        border: 1px solid var(--theme-color2);
        margin: 0 12px 0 25px;
    }

    .sidebar {
        transition: transform 1s;
        z-index: 9;
        height: 100%;
        position: absolute;
    }

    .right.collapsed {
        transform: translateX(340px);
    }

    .tabs-line.nav-tabs .nav-link.active,
    .tabs-line.nav-tabs .nav-link.active:hover,
    .tabs-line.nav-tabs .nav-link.active:focus,
    .tabs-line>.nav-tabs .nav-link.active,
    .tabs-line>.nav-tabs .nav-link.active:hover,
    .tabs-line>.nav-tabs .nav-link.active:focus {
        color: #fdac41;
    }

    .i-search {
        position: absolute;
        z-index: 10;
        right: 45px;
        top: 65px;
        width: 160px;
    }

    /* خصوصیات برای حالت دسکتاپ */
    .sidebar-content {
        position: absolute;
        width: 15vw;
        height: 97vh;
        color: #ccc;
        top: 5px;
        z-index: 999;
        border-top-left-radius: 5px;
        border-bottom-left-radius: 5px;
        right: 0;
        transition: right 1s ease-in-out;
        background: url(/Portals/2/Econet/Image/Skin/Other/pattern_h.png), #16515a;
        background-position: center center;
        background-repeat: repeat;
    }

    .sidebar-toggle {
        position: absolute;
        width: 40px;
        height: auto;
        overflow: visible;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        background-color: #16515a;
        top: 35vh;
        right: 15vw;
        border-top-left-radius: 20px;
        border-bottom-left-radius: 20px;
        transition: right 1s ease-in-out;
        display: block;
        border-right: 1px solid #fff;
    }

    .title-page {
        position: absolute;
        width: 15vw;
        height: auto;
        overflow: visible;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        background-color: #16515a;
        top: 0;
        right: 0;
        left: 0;
        margin: 0 auto;
        border-bottom-left-radius: 20px;
        border-bottom-right-radius: 20px;
        transition: right 1s ease-in-out;
        display: block;
        border-right: 1px solid #fff;
    }

    /* خصوصیات برای حالت موبایل */
    @media (max-width: 768px) {
        .sidebar-content {
            width: 50vw;
            right: 0;
        }

        .sidebar-toggle {
            right: 50vw;
        }

        body {
            overflow-y: scroll !important;
        }
    }

    .form-check {
        padding-right: 1.5em;
    }

    .form-check .form-check-input {
        float: right;
        margin-right: -1.5em;
    }

    .leaflet-control {
        font-size: 13px;
    }

    .logo-map {
        position: absolute;
        right: 25px;
        bottom: 25px;
        z-index: 9999;
    }

    .logo-map img {
        max-width: 70% !important;
    }

    .accordion-button::after {
        margin-left: 0;
        margin-right: auto;
    }

    .accordion {
        --bs-accordion-btn-focus-box-shadow: none !important;
    }

    .accordion-button:not(.collapsed) {
        color: #4f4f4f;
        background-color: #ff9600;
    }

    .accordion-button {
        background-color: #fff;
    }

    .crisel {
        width: 50px;
        height: 50px;
        border-radius: 100%;
        margin: 0 auto;
        text-align: center;
        position: absolute;
        left: 0;
        right: 0;
        top: 200px;
        background: #2A7B9B;
        background: radial-gradient(circle, #12c572fa 0%, #85d7b15e 50%, #ffffff00 100%);
    }

    .leaflet-fade-anim .leaflet-map-pane .leaflet-popup {
        min-width: 120px;
    }

    .leaflet-popup-content {
        margin: 13px 24px 13px 20px;
        font-size: 12px;
        padding: 5px;
        width: 100% !important;
    }

    .leaflet-popup-content-wrapper {
        text-align: center !important;
        border-radius: 5px !important;
    }

    .leaflet-popup-content {
        margin: 5px !important;
    }

    .toast-title h2 {
        font-size: 15px !important;
        font-weight: 700 !important;
    }

    .toast-title h2 i {
        right: -50px !important;
    }

    .toast-message p {
        font-size: 15px !important;
        font-weight: 400 !important;
    }

    .chartdiv {
        width: 250px;
        height: 300px;
        direction: ltr;
    }

    .chartdivmetro {
        width: 250px;
        height: auto;
    }
</style>

<div class="row bodyloader" id="loader">
    <div class="SubMaploader">
        <img src="/Portals/2/Econet/Image/Skin/solar/footer-shape1.png" style="max-width: 200px !important">
        <span class="Maploader my-4"></span>
        <div class="crisel"></div>
        <p class="t-x14 t-center">
            لطفا چند لحظه صبر نمایید...
        </p>
    </div>
</div>

<div id="right" class="sidebar right">
    <div class="sidebar-toggle" id="sidebar-toggle">
        <a id="custom-zoom-in" class="btn t-center py-1 px-1 my-0 mx-auto w-90 t-white" role="button">
            <i class="bx bx-plus link_toggle t-x18"></i>
        </a>
        <a id="custom-zoom-out" class="btn t-center py-1 px-1 my-0 mx-auto w-90 t-white" role="button">
            <i class="bx bx-minus link_toggle t-x18"></i>
        </a>
        <a id="sidebar-search-btn" class="btn t-center py-1 px-1 my-0 mx-auto w-90 t-white" role="button">
            <i class="bx bx-search-alt t-x18"></i>
        </a>
        <input id="sidebar-search-input" type="text" class="form-control d-none mt-2 i-search"
            placeholder="جستجوی مکان..." />
        <a role="button" onclick="_btnSidbare()">
            <i id="sidebar-toggle-icon" class="bx bx-right-arrow link_toggle t-warning t-x28"
                style="padding: 6px !important"></i>
        </a>
        <a id="sidebar-print-btn" class="btn t-center py-1 px-1 my-0 mx-auto w-100 t-white" role="button">
            <i class="bx bx-printer link_toggle t-x18"></i>
        </a>
        <a id="sidebar-fullscreen-btn" class="btn t-center py-1 px-1 my-0 mx-auto w-100 t-white" role="button">
            <i class="bx bx-fullscreen link_toggle t-x18"></i>
        </a>
        <a id="sidebar-location-btn" class="btn t-center py-1 px-1 my-0 mx-auto w-100 t-white" role="button">
            <i class="bx bx-map-pin link_toggle t-x18"></i>
        </a>
    </div>
    <div class="sidebar-content" id="sidebar-content">
        <div class="nav-align-top mb-4">
            <div class="titleimage">
                <img src="/Portals/2/Econet/Image/Skin/Other/logo-white.png" alt="" />
            </div>
            <div class="t-fw-700 t-x12 t-center t-white">
                داشبورد اطلاعات مکانی بر اساس شاخص های Iso
            </div>
            <hr />
            <div class="accordion" id="accordionExample">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingOne">
                        <button class="accordion-button py-0 mt-1  t-x14 t-right pl-3 pr-0" type="button"
                            data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true"
                            aria-controls="collapseOne">
                            <span class="py-0 px-2 ml-2 border-start border-primary">
                                <i class='bx bxs-traffic t-x24'></i>
                            </span>
                            <span class="t-x12 t-fw-700">
                                سهم خودروهای کم‌آلاینده ثبت‌شده
                            </span>
                        </button>
                    </h2>
                    <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne"
                        data-bs-parent="#accordionExample">
                        <div class="accordion-body">
                            <div class="mb-3">
                                <label for="exampleFormControlInput1" class="form-label t-x12 t-warning">
                                    انتخاب محدوده نمایش
                                </label>
                                <select class="form-select form-select-sm t-x10" id="regionhandleSelect"
                                    onchange="handleChangeSelect(this)" aria-label="Small select example">
                                    <option selected>
                                        یکی از مناطق را انتخاب نمایید ...
                                    </option>
                                    <option class="t-x10 t-dark" value="1">منطقه 1</option>
                                    <option class="t-x10 t-dark" value="2">منطقه 2</option>
                                    <option class="t-x10 t-dark" value="3">منطقه 3</option>
                                    <option class="t-x10 t-dark" value="4">منطقه 4</option>
                                    <option class="t-x10 t-dark" value="5">منطقه 5</option>
                                    <option class="t-x10 t-dark" value="6">منطقه 6</option>
                                    <option class="t-x10 t-dark" value="7">منطقه 7</option>
                                    <option class="t-x10 t-dark" value="8">منطقه 8</option>
                                    <option class="t-x10 t-dark" value="9">منطقه 9</option>
                                    <option class="t-x10 t-dark" value="10">منطقه 10</option>
                                    <option class="t-x10 t-dark" value="11">منطقه 11</option>
                                    <option class="t-x10 t-dark" value="12">منطقه 12</option>
                                    <option class="t-x10 t-dark" value="13">منطقه 13</option>
                                    <option class="t-x10 t-dark" value="14">منطقه 14</option>
                                    <option class="t-x10 t-dark" value="15">منطقه 15</option>
                                    <option class="t-x10 t-dark" value="16">منطقه 16</option>
                                    <option class="t-x10 t-dark" value="17">منطقه 17</option>
                                    <option class="t-x10 t-dark" value="18">منطقه 18</option>
                                    <option class="t-x10 t-dark" value="19">منطقه 19</option>
                                    <option class="t-x10 t-dark" value="20">منطقه 20</option>
                                    <option class="t-x10 t-dark" value="21">منطقه 21</option>
                                    <option class="t-x10 t-dark" value="22">منطقه 22</option>
                                </select>
                            </div>
                            <div class="mb-3 form-check">
                                <a onclick="handleCheckboxChange()"
                                    class="bttn bttn-info my-0 py-1 px-4 position-relative">
                                    <i class='bx bx-camera-home t-white t-x24'
                                        style="position: absolute;right: 0;top: 0"></i>
                                    دوربین ها
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingTwo">
                        <button class="accordion-button py-0 mt-1  t-x14 t-right pl-3 pr-0 collapsed" type="button"
                            data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false"
                            aria-controls="collapseTwo">
                            <span class="py-0 px-2 ml-2 border-start border-primary">
                                <i class='bx bx-car t-x24'></i>
                            </span>
                            <span class="t-x12 t-fw-700">
                                سهم حمل‌ونقل عمومیِ پرداخت یکپارچه
                            </span>
                        </button>
                    </h2>
                    <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo"
                        data-bs-parent="#accordionExample">
                        <div class="accordion-body">
                            <a onclick="showmetro4()" class="bttn bttn-info my-0 py-1 px-4 position-relative">
                                <i class='bx bx-train t-white t-x24' style="position: absolute;right: 0;top: 0"></i>
                                نمایش خط 4 مترو
                            </a>
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingThree">
                        <button class="accordion-button py-0 mt-1  t-x14 t-right pl-3 pr-0 collapsed" type="button"
                            data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false"
                            aria-controls="collapseThree">
                            <span class="py-0 px-2 ml-2 border-start border-primary">
                                <i class='bx bxs-parking t-x24'></i>
                            </span>
                            <span class="t-x12 t-fw-700">
                                سهم‌پارکینگ‌های‌عمومیِ پرداخت‌الکترونیکی
                            </span>
                        </button>
                    </h2>
                    <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree"
                        data-bs-parent="#accordionExample">
                        <div class="accordion-body">
                            <strong>This is the third item's accordion body.</strong> It is hidden by default, until the
                            collapse plugin adds the appropriate classes that we use to style each element. These
                            classes control the overall appearance, as well as the showing and hiding via CSS
                            transitions. You can modify any of this with custom CSS or overriding our default variables.
                            It's also worth noting that just about any HTML can go within the
                            <code>.accordion-body</code>, though the transition does limit overflow.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="map" style="height: 100vh !important; z-index: 1; border-radius: 5px" class="z-depth-1">
    <div class="logo-map">
        <img src="/Portals/2/Econet/Image/Skin/Other/logo.png" alt="">
    </div>
    <div id="bodychart" class="bodychart">
        <a onclick="closebodychart()" class="closebodychart">
            <i class="bx bx-x t-x24 t-danger"></i>
        </a>
        <div class="divider divider-success divider-dotted text-center mb-0 my-2 w-90">
            <div class="divider-text t-success t-x14 t-fw-700" id="titilechart"></div>
        </div>
        <div id="DivChart"></div>
    </div>
</div>

<script>
    "use strict";
    var layers = {};
    var Alllayers = {};
    var AlllayersNeighborhood = {};
    var pointLayers = [];
    let lineLayers = [];
    let plygonLayers = [];
    const cameraIcon = L.icon({
        iconUrl: 'https://plan.tehran.ir/Portals/2/Econet/Image/Map/cinema.png',
        iconSize: [30, 38],
        iconAnchor: [15, 38],
        popupAnchor: [0, -38]
    });

    const stationIcon = L.icon({
        iconUrl: 'https://plan.tehran.ir/Portals/2/Econet/Image/Map/POE/train.png',
        iconSize: [30, 38],
        iconAnchor: [15, 38],
        popupAnchor: [0, -38]
    });

    const map = L.map("map", {
        closePopupOnClick: false,
        zoomControl: false,
    }).setView([35.701985, 51.391204], 12);
    const Jawg_Light = L.tileLayer("https://tile.jawg.io/jawg-light/{z}/{x}/{y}{r}.png?access-token=oSSAwvXxOLWUv5azDzu5UhYho1Ik0bg5HRV28PSrjqSbs6IpNWBFkaLJCRRmTCDI", {
        attribution: "تمام حقوق این اثر برای اداره کل برنامه ریزی، بودجه و کنترل عملکرد محفوظ است",
        minZoom: 9,
        maxZoom: 22,
    }).addTo(map);
    document.getElementById("custom-zoom-in").addEventListener("click", function () {
        map.zoomIn();
    });
    document.getElementById("custom-zoom-out").addEventListener("click", function () {
        map.zoomOut();
    });
    document.getElementById("sidebar-print-btn").addEventListener("click", function () {
        window.print();
    });
    document.getElementById("sidebar-fullscreen-btn").addEventListener("click", function () {
        let elem = document.getElementById("map");
        if (!document.fullscreenElement) {
            elem.requestFullscreen();
        } else {
            document.exitFullscreen();
        }
    });
    document.getElementById("sidebar-location-btn").addEventListener("click", function () {
        if (!navigator.geolocation) {
            alert("مرورگر شما از موقعیت‌یاب پشتیبانی نمی‌کند!");
            return;
        }
        navigator.geolocation.getCurrentPosition(
            function (pos) {
                const latlng = [pos.coords.latitude, pos.coords.longitude];
                map.setView(latlng, 15);
                L.marker(latlng).addTo(map).bindPopup("شما اینجایید!").openPopup();
            },
            function () {
                alert("امکان دریافت موقعیت شما وجود ندارد.");
            }
        );
    });
    const cameraLayerGroup = L.layerGroup();

    const sidebarToggle = document.getElementById("sidebar-toggle");
    const sidebarIcon = sidebarToggle?.querySelector("i");
    if (sidebarIcon) {
        sidebarIcon.classList.remove("bx-right-arrow");
        sidebarIcon.classList.add("bx-left-arrow");
    } else {
        console.log("is not found ....");
    }
    let isSidebarCollapsed = false;

    function _btnSidbare() {
        const sidebarContent = document.getElementById("sidebar-content");
        const sidebarToggle = document.getElementById("sidebar-toggle");
        const sidebarIcon = document.getElementById("sidebar-toggle-icon");
        const isMobile = window.matchMedia("(max-width: 768px)").matches;

        if (!isSidebarCollapsed) {
            sidebarContent.style.right = isMobile ? "-50vw" : "-15vw";
            sidebarToggle.style.right = "0px";
            sidebarToggle.style.display = "inline";
            isSidebarCollapsed = true;

            if (sidebarIcon) {
                sidebarIcon.classList.remove("bx-right-arrow");
                sidebarIcon.classList.add("bx-left-arrow");
            } else {
                console.log("is not found ....");
            }
        } else {
            sidebarContent.style.right = "0px";
            sidebarToggle.style.right = isMobile ? "50vw" : "15vw";
            sidebarToggle.style.display = "block";
            isSidebarCollapsed = false;

            if (sidebarIcon) {
                sidebarIcon.classList.remove("bx-left-arrow");
                sidebarIcon.classList.add("bx-right-arrow");
            }
        }

        const shift = isMobile ? 0.02 : 0.05;
        const lngDelta = isSidebarCollapsed ? -shift : shift;

        map.flyTo([map.getCenter().lat, map.getCenter().lng + lngDelta], map.getZoom(), {
            animate: true,
            duration: 1,
            easeLinearity: 0.5,
        });
    }

    var _removeAllLayersMap = function () {
        // حذف لایه‌های نقطه از نقشه
        if (pointLayers.length > 0) {
            for (let i = 0; i < pointLayers.length; i++) {
                map.removeLayer(pointLayers[i]); // حذف لایه با ایندکس i
            }
            pointLayers = []; // خالی کردن آرایه
            console.log("تمام لایه ها از نوع نقاط حذف گردیدند");
        }

        // حذف لایه‌های خط از نقشه
        if (lineLayers.length > 0) {
            for (let i = 0; i < lineLayers.length; i++) {
                map.removeLayer(lineLayers[i]); // حذف لایه با ایندکس i
            }
            lineLayers = []; // خالی کردن آرایه
            console.log("تمام لایه ها از نوع لاین حذف گردیدند");
        }

        // حذف لایه‌های چندضلعی از نقشه
        if (plygonLayers.length > 0) {
            for (let i = 0; i < plygonLayers.length; i++) {
                map.removeLayer(plygonLayers[i]); // حذف لایه با ایندکس i
            }
            plygonLayers = []; // خالی کردن آرایه
            console.log("تمام لایه ها از نوع پلیگان حذف گردیدند");
        }
    };

    const createChart = (chartId, fuel_clean_percent, fuel_hybrid_percent, fuel_petrol_percent) => {
        // if (am4core.registry.baseSprites.some(sprite => sprite.htmlContainer.id === chartId)) {
        //     return; // چارت قبلاً ساخته شده است
        // }

        am4core.ready(() => {
            am4core.useTheme(am4themes_animated);

            const chart = am4core.create(chartId, am4charts.PieChart);

            const pieSeries = chart.series.push(new am4charts.PieSeries());
            pieSeries.dataFields.value = "litres";
            pieSeries.dataFields.category = "NameCamera";

            chart.innerRadius = am4core.percent(30);

            pieSeries.slices.template.stroke = am4core.color("#fff");
            pieSeries.slices.template.strokeWidth = 2;
            pieSeries.slices.template.strokeOpacity = 1;
            pieSeries.slices.template.cursorOverStyle = [{ property: "cursor", value: "pointer" }];

            pieSeries.alignLabels = false;
            pieSeries.labels.template.bent = true;
            pieSeries.labels.template.radius = 3;
            pieSeries.labels.template.padding(0, 0, 0, 0);
            pieSeries.ticks.template.disabled = true;

            const shadow = pieSeries.slices.template.filters.push(new am4core.DropShadowFilter());
            shadow.opacity = 0;

            const hoverState = pieSeries.slices.template.states.getKey("hover");
            const hoverShadow = hoverState.filters.push(new am4core.DropShadowFilter());
            hoverShadow.opacity = 0.7;
            hoverShadow.blur = 5;

            chart.legend = new am4charts.Legend();

            // ـــــ خواندن رنگ از داده‌ها ـــــ
            pieSeries.slices.template.propertyFields.fill = "color";
            pieSeries.slices.template.propertyFields.stroke = "color";
            pieSeries.legendSettings.valueText = "{value.percent.formatNumber('#.0')}%";

            // اگر می‌خواهی در حالت hover هم همان رنگ حفظ شود:
            pieSeries.slices.template.states.getKey("hover").propertyFields.fill = "color";
            pieSeries.slices.template.states.getKey("hover").propertyFields.stroke = "color";

            chart.data = [
                {
                    NameCamera: "سوخت ترکیبی",
                    litres: fuel_clean_percent,
                    color: "#ff9600"
                },
                {
                    NameCamera: "سوخت پاک",
                    litres: fuel_hybrid_percent,
                    color: "#0dff00"
                },
                {
                    NameCamera: "سوخت بنزینی",
                    litres: fuel_petrol_percent,
                    color: "#ff0000"
                }
            ];
        });
    };

    let _creatPopUp = (_title, regionid) => {
        const chartId = `chartdiv-${regionid}`;

        const html = [
            '<p class="t-right t-fw-700 t-dark t-x10 mb-0">',
            _title,
            '</p>',
            `<div id="${chartId}" class="chartdiv"></div>`
        ].join("");

        // فقط HTML را برگردانید؛ چارت را بعد از باز شدن پاپ‌آپ بسازید
        return { html, chartId };
    };

    const _creatPopUpstationMetro = (
        title,
        incomingsPercent,
        outgoingsPercent,
        abtPercent,
        directCardPercent
    ) => {
        const sanitizePercent = (value) => {
            const num = Number(value);
            if (Number.isFinite(num)) {
                return Math.max(0, Math.min(100, num));
            }
            return 0;
        };

        const Incomings = sanitizePercent(incomingsPercent);
        const Outgoings = sanitizePercent(outgoingsPercent);
        const PaymentByAbt = sanitizePercent(abtPercent);
        const PaymentByDirectCard = sanitizePercent(directCardPercent);

        const html = [
            '<div class="chartdivmetro">',
            '<p class="t-center t-fw-700 t-success t-x14 my-0">',
            title,
            '</p>',
            '<hr>',
            '<h1 class="t-right t-fw-700 t-x14 t-dark mb-1">میزان ورودی و خروجی</h1>',
            '<div class="d-flex w-100 overflow-hidden rounded">',
            `<div class="bg-success" style="width:${Incomings}%;">`,
            '<div class="t-center t-white py-1">ورودی‌ها</div>',
            '</div>',
            `<div class="bg-danger" style="width:${Outgoings}%;">`,
            '<div class="t-center t-white py-1">خروجی‌ها</div>',
            '</div>',
            '</div>',
            '<hr>',
            '<h1 class="t-right t-fw-700 t-x14 t-dark mb-1">خرید بلیط</h1>',
            '<div class="d-flex w-100 overflow-hidden rounded">',
            `<div class="bg-success" style="width:${PaymentByAbt}%;">`,
            '<div class="t-center t-white py-1">شارژ با ABT</div>',
            '</div>',
            `<div class="bg-danger" style="width:${PaymentByDirectCard}%;">`,
            '<div class="t-center t-white py-1">شارژ مستقیم</div>',
            '</div>',
            '</div>',
            '</div>'
        ].join("");

        return { html };
    };


    var _createPolygonLayer = function (_polygon, _weight, _color, _fillOpacity) {
        console.log("_polygon:", _polygon);

        if (!_polygon || _polygon.length === 0) {
            console.warn("مختصات خالی است");
            return null;
        }

        const fixedCoords = _polygon.map(([lng, lat]) => [lat, lng]);
        console.log("fixedCoords:", fixedCoords);

        let layer = L.polygon(fixedCoords, {   // << اینجا اصلاح شد
            color: _color,
            weight: _weight,
            opacity: 1,
            fillColor: _color,
            fillOpacity: _fillOpacity
        });

        plygonLayers.push(layer);
        layer.addTo(map);
        return layer;
    };

    let _flytoLatLon = (lat, lng) => {
        // مرحله 1: هم‌زمان زوم‌اوت به 6 و حرکت به مقصد
        map.flyTo([lat, lng], 12, {
            animate: true,
            duration: 1.6,
            easeLinearity: 0.25
        });

        // مرحله 2: بعد از رسیدن، زوم‌این به 12
        map.once('moveend', () => {
            map.flyTo([lat, lng], 14, {
                animate: true,
                duration: 1.0,
                easeLinearity: 0.25
            });
        });
    };

    let _flyToBounds = () => {
        const bounds = layer.getBounds();

        // مرحله 1: هم‌زمان زوم‌اوت و حرکت به مرکز پلیگان
        map.flyTo(bounds.getCenter(), 6, {
            animate: true,
            duration: 1.5,
            easeLinearity: 0.25
        });

        // مرحله 2: فیت دقیق محدوده پلیگان
        map.once('moveend', () => {
            map.flyToBounds(bounds, {
                padding: [20, 20],
                duration: 1.2,
                easeLinearity: 0.25,
                maxZoom: 12   // جلو‌گیری از زوم خیلی نزدیک
            });
        });
    };

    var _checkStaticLayer = function (LayerName) {
        if (layers[LayerName]) {
            map.removeLayer(layers[LayerName]);
            delete layers[LayerName];
            return;
        }

        const region = cityTehran.features.find(f => f.properties.regionName === LayerName);

        if (!region) {
            console.warn("منطقه یافت نشد:", LayerName);
            return;
        }

        let coords = region.geometry.coordinates;

        // اگر MultiPolygon بود، اولین پلیگان را بگیر
        if (region.geometry.type === "MultiPolygon") {
            coords = coords[0][0];
        } else {
            coords = coords[0];
        }

        _removeAllLayersMap();
        const myPolygon = _createPolygonLayer(coords, 1, "#0093ff", 0.1);
        if (!myPolygon) return;

        _flytoLatLon(region.properties.lat, region.properties.lon);

        layers[LayerName] = myPolygon;
    };

    const handleCheckboxChange = () => {
        const select = document.getElementById('regionhandleSelect');
        const regionValue = Number(select.value);

        if (!regionValue) {
            AsyncTask.Constructors.CeartMessage('WarningMessage', 'کاربر رگامی', 'در ابتدا یکی از مناطق را انتخاب نمایید...');
            cameraLayerGroup.clearLayers();
            if (map.hasLayer(cameraLayerGroup)) {
                map.removeLayer(cameraLayerGroup);
            }
            return;
        }

        // جلوگیری از ذخیرهٔ تکراری
        if (!pointLayers.includes(cameraLayerGroup)) {
            pointLayers.push(cameraLayerGroup);
        }

        cameraLayerGroup.clearLayers();

        const filteredFeatures = CameraGeoJSON.features.filter((feature) => {
            return Number(feature.properties.regionId) === regionValue;
        });

        if (filteredFeatures.length === 0) {
            console.warn('در این منطقه دوربینی یافت نشد');
            if (map.hasLayer(cameraLayerGroup)) {
                map.removeLayer(cameraLayerGroup);
            }
            return;
        }

        const FeatureCollectioncamera = {
            type: "FeatureCollection",
            features: filteredFeatures
        };

        if (!map.hasLayer(cameraLayerGroup)) {
            cameraLayerGroup.addTo(map);
        }

        L.geoJSON(FeatureCollectioncamera, {
            pointToLayer: (feature, latlng) => L.marker(latlng, { icon: cameraIcon }),
            onEachFeature: (feature, layer) => {
                const fuel_clean_percent = feature.properties.fuel_clean_percent || "نام دوربین نامشخص";
                const fuel_hybrid_percent = feature.properties.fuel_hybrid_percent || "نام دوربین نامشخص";
                const fuel_petrol_percent = feature.properties.fuel_petrol_percent || "نام دوربین نامشخص";

                const regionId = feature.properties.regionId || "unknown";
                const { html, chartId } = _creatPopUp("title", regionId);

                layer.bindPopup(html);

                layer.on("popupopen", () => {
                    createChart(chartId, fuel_clean_percent, fuel_hybrid_percent, fuel_petrol_percent);
                });

                layer.on("popupclose", () => {
                    const chart = am4core.registry.baseSprites.find(sprite => sprite.htmlContainer.id === chartId);
                    if (chart) {
                        chart.dispose();
                    }
                });
            }
        }).addTo(cameraLayerGroup);

    };

    function handleChangeSelect(selectEl) {
        const value = selectEl.value;
        //const text = selectEl.options[selectEl.selectedIndex].text;

        if (!value) {
            console.log('هنوز انتخابی انجام نشده');
            return;
        }

        let CreatlayerName = 'region_' + value;
        console.log('value:', value);
        console.log('CreatlayerName:', CreatlayerName);
        _checkStaticLayer(CreatlayerName);

        //_flytoLatLon(35.712794, 51.334053);
    }

    const showmetro4 = () => {
        const metroLine4Layer = L.geoJSON(railwaymetro4, {
            style: (feature) => {
                if (feature.geometry.type === "LineString") {
                    return {
                        color: "#f9a825",
                        weight: 5,
                        opacity: 0.9,
                        interactive: false
                    };
                }
            },

            pointToLayer: (feature, latlng) => {
                if (feature.geometry.type === "Point") {
                    return L.marker(latlng, { icon: stationIcon });
                }
            },

            onEachFeature: (feature, layer) => {
                if (feature.geometry.type !== "Point") {
                    return;
                }

                const props = feature.properties ?? {};

                const name = props.name ?? "ایستگاه بدون نام";
                const incomings = props.Incomings ?? 0;
                const outgoings = props.Outgoings ?? 0;
                const paymentByAbt = props.PaymentByAbt ?? 0;
                const paymentByDirectCard = props.PaymentByDirectCard ?? 0;

                const { html } = _creatPopUpstationMetro(
                    name,
                    incomings,
                    outgoings,
                    paymentByAbt,
                    paymentByDirectCard
                );

                layer.bindPopup(html);
            }
        });

        metroLine4Layer.addTo(map);
        return metroLine4Layer;
    };

    map.whenReady(() => {
        // یک لایه برای همه مناطق
        const regionsLayer = L.geoJSON(cityTehran, {
            style: (feature) => ({
                color: '#1565c0', // رنگ خط
                weight: 1.5, // ضخامت خط
                fillColor: '#00ff0a', // رنگ پر
                fillOpacity: 0 // شفافیت پر
            }),
            onEachFeature: (feature, layer) => {
                const name = feature.properties.name || 'نامشخص';
                layer.bindPopup(`منطقه: ${name}`);
            }
        }).addTo(map);

        document.getElementById("loader").style.display = "none";
    });
</script>